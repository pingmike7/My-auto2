name: Cleanup Old Workflow Runs

on:
  schedule:
    - cron: '0 18 * * 5' # æ¯å‘¨ä¸€ UTC 03:00ï¼ˆåŒ—äº¬æ—¶é—´ 11:00ï¼‰
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      # 1ï¸âƒ£ Checkout å½“å‰ä»“åº“
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          path: repo

      # 2ï¸âƒ£ å®‰è£… gh CLI å’Œ jq
      - name: Setup gh CLI
        run: |
          sudo apt update
          sudo apt install -y gh jq

      # 3ï¸âƒ£ æ¸…ç† workflow runs + artifactsï¼Œå¹¶ç”Ÿæˆæ—¥å¿—
      - name: Cleanup old workflow runs and artifacts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DAYS_TO_KEEP: 7
          REPO: ${{ github.repository }}
        run: |
          cutoff=$(date -u -d "$DAYS_TO_KEEP days ago" +%Y-%m-%dT%H:%M:%SZ)
          LOG_BODY=""

          echo "ğŸ“¦ Cleaning old workflow runs..."
          runs=$(gh api repos/$REPO/actions/runs --jq ".workflow_runs[] | select(.created_at < \"$cutoff\") | .id")
          if [ -z "$runs" ]; then
            LOG_BODY="$LOG_BODY\tâ€¢ No old workflow runs to delete\n"
          else
            for run_id in $runs; do
              gh api -X DELETE repos/$REPO/actions/runs/$run_id
              LOG_BODY="$LOG_BODY\tâ€¢ Deleted workflow run $run_id\n"
            done
          fi

          echo "ğŸ“¦ Cleaning old artifacts..."
          artifacts=$(gh api repos/$REPO/actions/artifacts --jq ".artifacts[] | select(.created_at < \"$cutoff\") | .id")
          if [ -z "$artifacts" ]; then
            LOG_BODY="$LOG_BODY\tâ€¢ No old artifacts to delete\n"
          else
            for art_id in $artifacts; do
              gh api -X DELETE repos/$REPO/actions/artifacts/$art_id
              LOG_BODY="$LOG_BODY\tâ€¢ Deleted artifact $art_id\n"
            done
          fi

          # ç”Ÿæˆæ–°æ—¥å¿—å—ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
          LOG="### Cleanup Log ($(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S'))\n$LOG_BODY"

          README="repo/README.md"
          if [ -f "$README" ]; then
            CONTENT=$(cat "$README")
          else
            CONTENT=""
          fi

          # å°†æ–°æ—¥å¿—è¿½åŠ åˆ°é¡¶éƒ¨
          echo -e "$LOG\n$CONTENT" > tmp_readme.md

          # ä¿ç•™æœ€å¤š 50 æ¡ Cleanup Log
          awk '
            BEGIN {count=0; max=50; RS="### Cleanup Log"; ORS=""}
            NR==1 {head=$0; next}
            {blocks[NR]=$0; count++}
            END {
              print head
              start = (count>max)?(count-max+1):1
              for(i=start;i<=count;i++) print "### Cleanup Log" blocks[i]
            }
          ' tmp_readme.md > "$README"

          rm tmp_readme.md

      # 4ï¸âƒ£ æäº¤ README.md
      - name: Commit README update
        working-directory: repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git diff --cached --quiet || (git commit -m "ğŸ§¹ Cleanup workflow runs & artifacts log" && git push origin HEAD:main)
